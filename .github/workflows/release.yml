name: Release

on:
  push:
    tags:
      - 'v*'
      - 'latest'

jobs:
  cleanup:
    if: github.ref_name == 'latest'
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Delete existing latest release
        run: gh release delete latest --yes --cleanup-tag || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

  build:
    needs: [cleanup]
    if: always() && (needs.cleanup.result == 'success' || needs.cleanup.result == 'skipped')
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            label: 'macOS-ARM64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            label: 'macOS-Intel'
          - platform: 'ubuntu-22.04'
            args: ''
            label: 'Linux'
          - platform: 'windows-latest'
            args: ''
            label: 'Windows'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust targets (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        with:
          args: ${{ matrix.args }}

      - name: Rename artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          cd src-tauri/target/*/release/bundle/dmg/
          for f in *.dmg; do
            if [[ "$f" == *"aarch64"* ]]; then
              newname="${f//_aarch64/_macOS-ARM64}"
            elif [[ "$f" == *"x64"* ]] || [[ "$f" == *"x86_64"* ]]; then
              newname="${f//_x64/_macOS-Intel}"
              newname="${newname//_x86_64/_macOS-Intel}"
            else
              newname="$f"
            fi
            if [ "$f" != "$newname" ]; then
              mv "$f" "$newname"
              echo "Renamed: $f -> $newname"
            fi
          done

      - name: Rename artifacts (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          # Rename .deb
          cd src-tauri/target/release/bundle/deb/
          for f in *.deb; do
            newname="${f//_amd64/_Linux-amd64}"
            if [ "$f" != "$newname" ]; then
              mv "$f" "$newname"
              echo "Renamed: $f -> $newname"
            fi
          done

          # Rename .AppImage
          cd ../appimage/
          for f in *.AppImage; do
            newname="${f//_amd64/_Linux-amd64}"
            if [ "$f" != "$newname" ]; then
              mv "$f" "$newname"
              echo "Renamed: $f -> $newname"
            fi
          done

      - name: Rename artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        run: |
          # Rename .msi
          $msiDir = "src-tauri/target/release/bundle/msi"
          Get-ChildItem -Path $msiDir -Filter "*.msi" | ForEach-Object {
            $newName = $_.Name -replace '_x64_en-US', '_Windows'
            if ($_.Name -ne $newName) {
              Rename-Item -Path $_.FullName -NewName $newName
              Write-Host "Renamed: $($_.Name) -> $newName"
            }
          }

          # Rename .exe (NSIS)
          $nsisDir = "src-tauri/target/release/bundle/nsis"
          Get-ChildItem -Path $nsisDir -Filter "*.exe" | ForEach-Object {
            $newName = $_.Name -replace '_x64-setup', '_Windows-setup'
            if ($_.Name -ne $newName) {
              Rename-Item -Path $_.FullName -NewName $newName
              Write-Host "Renamed: $($_.Name) -> $newName"
            }
          }

      - name: Upload artifacts to versioned release
        if: startsWith(github.ref_name, 'v')
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          name: 'Beads Task-Issue Tracker ${{ github.ref_name }}'
          body: |
            See the [CHANGELOG](https://github.com/w3dev33/beads-task-issue-tracker/blob/main/CHANGELOG.md) for details.

            ## Installation

            | Platform | File | Notes |
            |----------|------|-------|
            | **macOS (Apple Silicon M1/M2/M3)** | `*_macOS-ARM64.dmg` | For Mac 2020+ |
            | **macOS (Intel)** | `*_macOS-Intel.dmg` | For Mac pre-2020 |
            | **Windows** | `*_Windows.msi` | Recommended installer |
            | **Linux (Debian/Ubuntu)** | `*_Linux-amd64.deb` | Recommended for Debian 12+, Ubuntu 22+ |
            | **Linux (other)** | `*_Linux-amd64.AppImage` | Requires `libfuse2` |
          files: |
            src-tauri/target/*/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts to latest release
        if: github.ref_name == 'latest'
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: true
          name: 'Beads Task-Issue Tracker - Latest Development Build'
          body: |
            **This is an automatically generated development build from the latest code on `master`.**

            This release is updated on each `/create-release latest` invocation. It always reflects the most recent development state.

            ## Installation

            | Platform | File | Notes |
            |----------|------|-------|
            | **macOS (Apple Silicon M1/M2/M3)** | `*_macOS-ARM64.dmg` | For Mac 2020+ |
            | **macOS (Intel)** | `*_macOS-Intel.dmg` | For Mac pre-2020 |
            | **Windows** | `*_Windows.msi` | Recommended installer |
            | **Linux (Debian/Ubuntu)** | `*_Linux-amd64.deb` | Recommended for Debian 12+, Ubuntu 22+ |
            | **Linux (other)** | `*_Linux-amd64.AppImage` | Requires `libfuse2` |

            ## macOS: First Launch

            macOS may block the app because it's not signed with an Apple Developer certificate.

            **To fix this**, run:
            ```bash
            xattr -cr /Applications/Beads\ Task-Issue\ Tracker.app
            ```
          files: |
            src-tauri/target/*/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
